"""
Greeting Generator - –≥–µ–Ω–µ—Ä–∞—Ü—ñ—è –ø—Ä–∏–≤—ñ—Ç–∞–Ω—å –∑ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—î—é –ø—Ä–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ –¥–æ–∫—É–º–µ–Ω—Ç–∏
"""
import os
from typing import Optional
from langchain_openai import ChatOpenAI
from dotenv import load_dotenv
from .vector_store import VectorStoreManager

load_dotenv()


def generate_greeting_with_documents(
    vector_store_manager: VectorStoreManager,
    use_llm: bool = True
) -> str:
    """
    –ì–µ–Ω–µ—Ä—É—î –ø—Ä–∏–≤—ñ—Ç–∞–Ω–Ω—è –∑ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—î—é –ø—Ä–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ –¥–æ–∫—É–º–µ–Ω—Ç–∏

    Args:
        vector_store_manager: –ú–µ–Ω–µ–¥–∂–µ—Ä –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ —Å—Ö–æ–≤–∏—â–∞
        use_llm: –ß–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ LLM –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó –ø—Ä–∏–≤—ñ—Ç–∞–Ω–Ω—è

    Returns:
        str: –ü—Ä–∏–≤—ñ—Ç–∞–Ω–Ω—è –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
    """
    # –û—Ç—Ä–∏–º—É—î–º–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –¥–æ–∫—É–º–µ–Ω—Ç–∏
    summary = vector_store_manager.get_documents_summary()

    # –Ø–∫—â–æ –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤ –Ω–µ–º–∞—î
    if not summary["has_documents"]:
        return (
            "üëã –ü—Ä–∏–≤—ñ—Ç! –Ø —Ç–≤—ñ–π –∞—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è —Ä–æ–±–æ—Ç–∏ –∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏.\n\n"
            "–ù–∞—Ä–∞–∑—ñ –≤ –±–∞–∑—ñ –¥–∞–Ω–∏—Ö –Ω–µ–º–∞—î –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤. "
            "–¢–∏ –º–æ–∂–µ—à –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ PDF –¥–æ–∫—É–º–µ–Ω—Ç–∏, —ñ —è –∑–º–æ–∂—É –¥–æ–ø–æ–º–æ–≥—Ç–∏ —Ç–æ–±—ñ –∑–Ω–∞–π—Ç–∏ –≤ –Ω–∏—Ö —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é!\n\n"
            "–©–æ–± –¥—ñ–∑–Ω–∞—Ç–∏—Å—è –ø—Ä–æ –¥–æ—Å—Ç—É–ø–Ω—ñ –∫–æ–º–∞–Ω–¥–∏, –≤–≤–µ–¥–∏ 'help' –∞–±–æ '–¥–æ–ø–æ–º–æ–≥–∞'."
        )

    # –Ø–∫—â–æ –¥–æ–∫—É–º–µ–Ω—Ç–∏ —î, –∞–ª–µ –Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ LLM
    if not use_llm:
        return _generate_simple_greeting(summary)

    # –ì–µ–Ω–µ—Ä—É—î–º–æ –ø—Ä–∏–≤—ñ—Ç–∞–Ω–Ω—è –∑ LLM
    try:
        return _generate_llm_greeting(summary)
    except Exception as e:
        print(f"–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó –ø—Ä–∏–≤—ñ—Ç–∞–Ω–Ω—è –∑ LLM: {e}")
        return _generate_simple_greeting(summary)


def _generate_simple_greeting(summary: dict) -> str:
    """
    –ì–µ–Ω–µ—Ä—É—î –ø—Ä–æ—Å—Ç–µ –ø—Ä–∏–≤—ñ—Ç–∞–Ω–Ω—è –±–µ–∑ LLM

    Args:
        summary: –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –¥–æ–∫—É–º–µ–Ω—Ç–∏

    Returns:
        str: –ü—Ä–∏–≤—ñ—Ç–∞–Ω–Ω—è
    """
    file_count = summary["file_count"]
    chunk_count = summary["count"]

    greeting = (
        f"üëã –ü—Ä–∏–≤—ñ—Ç! –Ø —Ç–≤—ñ–π –∞—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è —Ä–æ–±–æ—Ç–∏ –∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏.\n\n"
        f"üìö –£ –±–∞–∑—ñ –¥–∞–Ω–∏—Ö –∑–∞—Ä–∞–∑ —î {file_count} –¥–æ–∫—É–º–µ–Ω—Ç(—ñ–≤) ({chunk_count} —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ñ–≤):\n\n"
    )

    # –î–æ–¥–∞—î–º–æ —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª—ñ–≤
    for i, file_info in enumerate(summary["files"], 1):
        name = file_info["name"]
        page_count = file_info["page_count"]
        greeting += f"{i}. {name} ({page_count} —Å—Ç–æ—Ä—ñ–Ω–æ–∫)\n"

    greeting += (
        "\nüí° –Ø –º–æ–∂—É –¥–æ–ø–æ–º–æ–≥—Ç–∏ —Ç–æ–±—ñ:\n"
        "‚Ä¢ –ó–Ω–∞–π—Ç–∏ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –≤ —Ü–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö (–ø—Ä–æ—Å—Ç–æ –ø–æ–ø—Ä–æ—Å–∏ –º–µ–Ω–µ –∑–Ω–∞–π—Ç–∏ —â–æ—Å—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–µ)\n"
        "‚Ä¢ –í—ñ–¥–ø–æ–≤—ñ—Å—Ç–∏ –Ω–∞ –∑–∞–≥–∞–ª—å–Ω—ñ –ø–∏—Ç–∞–Ω–Ω—è\n"
        "‚Ä¢ –î–æ–ø–æ–º–æ–≥—Ç–∏ –∑—Ä–æ–∑—É–º—ñ—Ç–∏ –≤–º—ñ—Å—Ç –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤\n\n"
        "–ü—Ä–æ —â–æ —Ö–æ—á–µ—à –¥—ñ–∑–Ω–∞—Ç–∏—Å—è?"
    )

    return greeting


def _generate_llm_greeting(summary: dict) -> str:
    """
    –ì–µ–Ω–µ—Ä—É—î –ø–µ—Ä—Å–æ–Ω–∞–ª—ñ–∑–æ–≤–∞–Ω–µ –ø—Ä–∏–≤—ñ—Ç–∞–Ω–Ω—è –∑ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è–º LLM

    Args:
        summary: –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –¥–æ–∫—É–º–µ–Ω—Ç–∏

    Returns:
        str: –ü—Ä–∏–≤—ñ—Ç–∞–Ω–Ω—è –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–µ LLM
    """
    llm = ChatOpenAI(
        model=os.getenv("OPENAI_MODEL_NAME", "gpt-4o-mini"),
        temperature=0.7,
        api_key=os.getenv("OPENAI_API_KEY")
    )

    file_count = summary["file_count"]
    files_list = "\n".join([
        f"- {file_info['name']} ({file_info['page_count']} —Å—Ç–æ—Ä—ñ–Ω–æ–∫)"
        for file_info in summary["files"]
    ])

    prompt = f"""–¢–∏ - –¥—Ä—É–∂–Ω—ñ–π –∞—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è —Ä–æ–±–æ—Ç–∏ –∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º–∏. –ó–≥–µ–Ω–µ—Ä—É–π –∫–æ—Ä–æ—Ç–∫–µ (2-3 —Ä–µ—á–µ–Ω–Ω—è)
—Ç–∞ –¥—Ä—É–∂–Ω—î –ø—Ä–∏–≤—ñ—Ç–∞–Ω–Ω—è —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é –º–æ–≤–æ—é –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞.

–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ –¥–æ–∫—É–º–µ–Ω—Ç–∏:
- –ö—ñ–ª—å–∫—ñ—Å—Ç—å —Ñ–∞–π–ª—ñ–≤: {file_count}
- –§–∞–π–ª–∏:
{files_list}

–ü—Ä–∏–≤—ñ—Ç–∞–Ω–Ω—è –º–∞—î:
1. –ü—Ä–∏–≤—ñ—Ç–∞—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
2. –ü–æ–≤—ñ–¥–æ–º–∏—Ç–∏ —Å–∫—ñ–ª—å–∫–∏ –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ
3. –ó–∞–ø—Ä–æ–ø–æ–Ω—É–≤–∞—Ç–∏ –¥–æ–ø–æ–º–æ–≥—É –≤ –ø–æ—à—É–∫—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –≤ —Ü–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö
4. –ë—É—Ç–∏ –∫–æ—Ä–æ—Ç–∫–∏–º —Ç–∞ –¥—Ä—É–∂–Ω—ñ–º

–ù–µ –¥–æ–¥–∞–≤–∞–π emoji. –ü—Ä–æ—Å—Ç–æ —Ç–µ–∫—Å—Ç —É–∫—Ä–∞—ó–Ω—Å—å–∫–æ—é –º–æ–≤–æ—é."""

    try:
        response = llm.invoke(prompt)
        greeting = response.content.strip()

        # –î–æ–¥–∞—î–º–æ —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª—ñ–≤ –ø—ñ—Å–ª—è –ø—Ä–∏–≤—ñ—Ç–∞–Ω–Ω—è
        greeting += f"\n\nüìö –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ –¥–æ–∫—É–º–µ–Ω—Ç–∏:\n{files_list}"
        greeting += "\n\nüí° –©–æ–± –∑–Ω–∞–π—Ç–∏ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö, –ø—Ä–æ—Å—Ç–æ –ø–æ–ø—Ä–æ—Å–∏ –º–µ–Ω–µ –∑–Ω–∞–π—Ç–∏ —â–æ—Å—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–µ!"

        return greeting
    except Exception as e:
        raise e


def get_documents_context(vector_store_manager: VectorStoreManager) -> str:
    """
    –ì–µ–Ω–µ—Ä—É—î –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ –¥–æ–∫—É–º–µ–Ω—Ç–∏ –¥–ª—è –∞–≥–µ–Ω—Ç–∞

    Args:
        vector_store_manager: –ú–µ–Ω–µ–¥–∂–µ—Ä –≤–µ–∫—Ç–æ—Ä–Ω–æ–≥–æ —Å—Ö–æ–≤–∏—â–∞

    Returns:
        str: –ö–æ–Ω—Ç–µ–∫—Å—Ç –ø—Ä–æ –¥–æ–∫—É–º–µ–Ω—Ç–∏
    """
    summary = vector_store_manager.get_documents_summary()

    if not summary["has_documents"]:
        return "–í –±–∞–∑—ñ –¥–∞–Ω–∏—Ö –Ω–µ–º–∞—î –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∏—Ö –¥–æ–∫—É–º–µ–Ω—Ç—ñ–≤."

    files_list = ", ".join([file_info["name"] for file_info in summary["files"]])

    context = (
        f"–í –±–∞–∑—ñ –¥–∞–Ω–∏—Ö —î {summary['file_count']} –¥–æ–∫—É–º–µ–Ω—Ç(—ñ–≤): {files_list}. "
        f"–Ø–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á —è–≤–Ω–æ –ø–æ–ø—Ä–æ—Å–∏—Ç—å –∑–Ω–∞–π—Ç–∏ —â–æ—Å—å –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö, "
        f"–≤–∏–∫–æ—Ä–∏—Å—Ç–∞–π —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç 'Search PDF Documents'."
    )

    return context
