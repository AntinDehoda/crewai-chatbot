import os
from dotenv import load_dotenv
from crewai import Agent
from langchain_openai import ChatOpenAI
from typing import Optional, List

# Завантаження змінних оточення
load_dotenv()


def create_conversation_agent(tools: Optional[List] = None):
    """
    Створює базовий Conversation Agent з використанням OpenAI GPT-4o-mini

    Args:
        tools: Список інструментів для агента (опціонально)
    """

    # Ініціалізація LLM
    llm = ChatOpenAI(
        model=os.getenv("OPENAI_MODEL_NAME", "gpt-4o-mini"),
        temperature=0.7,
        api_key=os.getenv("OPENAI_API_KEY")
    )

    # Оновлений backstory з чіткими інструкціями про використання RAG
    backstory = """Ти - дружній та компетентний асистент, який допомагає
    користувачам у різних питаннях. Ти завжди намагаєшся зрозуміти контекст
    розмови та надати релевантні та корисні відповіді.

    У тебе є доступ до інструменту пошуку в завантажених PDF документах
    ('Search PDF Documents'). ВАЖЛИВО: використовуй цей інструмент ТІЛЬКИ
    коли користувач ЯВНО просить знайти, шукати або отримати інформацію з документів.

    Приклади явних запитів для використання інструменту:
    - "Знайди в документах інформацію про..."
    - "Що сказано в документі про..."
    - "Пошукай в файлах дані про..."
    - "Які деталі в документах про..."
    - "Що написано про..."

    Приклади НЕ явних запитів (НЕ використовуй інструмент):
    - "Розкажи про..." (загальне питання)
    - "Що таке...?" (загальне питання)
    - "Як працює...?" (загальне питання)

    Якщо користувач не просить явно шукати в документах, відповідай
    на основі своїх загальних знань. Ти маєш бути корисним помічником
    як для загальних питань, так і для роботи з документами."""

    # Створення агента
    agent_params = {
        "role": "Асистент для розмови",
        "goal": "Підтримувати природну та корисну розмову з користувачем та допомагати знаходити інформацію в документах",
        "backstory": backstory,
        "verbose": True,
        "memory": True,
        "llm": llm,
        "allow_delegation": False
    }

    # Додаємо інструменти якщо надані
    if tools:
        agent_params["tools"] = tools

    conversation_agent = Agent(**agent_params)

    return conversation_agent